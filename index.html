<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>redis_twitter_example.sh</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
    <tbody>
    <tr id='section-Redis_Twitter_Example'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Redis_Twitter_Example">&#182;</a>
        </div>
        <h1>Redis Twitter Example</h1>

<h2>An Executable Tutorial</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>This file contains a tutorial explaining core concepts of the <a href="http://redis.io/"><em>Redis</em></a>
database, dressed as a fully working bash script. All the words in UPPERCASE are <em>Redis</em>
built-in commands. All the words in lowercase are parameters for those commands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>The tutorial implements a simplified <em>Twitter</em> clone, loosely based on the now classic
<a href="http://redis.io/topics/twitter-clone"><em>TwitterAlikeExample</em></a>
by <a href="twitter.com/antirez"><code>@antirez</code></a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>You may copy and paste snippets from this file, or run it directly:</p>

<pre><code>$ bash redis_twitter_example.sh
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p><img src="http://github.com/favicon.ico" style="position:relative; top:2px">
The full source for this tutorial is available at <a href="http://github.com/karmi/redis_twitter_example">http://github.com/karmi/redis_twitter_example</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <hr>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>First, let&rsquo;s create some aliases for better code readability.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">shopt</span>    -s expand_aliases
<span class="nb">alias    </span><span class="nv">t</span><span class="o">=</span><span class="s2">&quot;date +%H:%M&quot;</span>
<span class="nb">export   </span><span class="nv">db</span><span class="o">=</span><span class="s2">&quot;13&quot;</span>
<span class="nb">alias</span>    %<span class="o">=</span><span class="s2">&quot;redis-cli -n $db&quot;</span>
<span class="k">function</span>  + <span class="o">()</span> <span class="o">{</span> <span class="nb">echo</span>; <span class="nb">echo</span> -e <span class="s2">&quot;# \033[1m$@\033[0m&quot;</span>; <span class="k">for </span>i in <span class="o">{</span>1..60<span class="o">}</span>; <span class="k">do </span><span class="nb">echo</span> -n <span class="s1">&#39;‾&#39;</span>; <span class="k">done</span>; <span class="nb">echo</span>; <span class="o">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Second, let&rsquo;s wipe the selected <em>Redis</em> database clean.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% FLUSHDB</pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>OK. We&rsquo;re ready to add some users to our “twitter”. We will use a <em>set</em> for storing users.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Let&#39;s add some users, A and B&quot;</span>
% SADD users A
% SADD users B</pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Let&rsquo;s make user A follow user B. We will use a <em>set</em> for this, again.
Notice the first place where we denormalize the data, storing both
sides of the relationship in discrete sets.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;User A follows user B&quot;</span>
% SADD users:A:following B
% SADD users:B:followers A</pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>We will add another user, C.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Let&#39;s add another user, C&quot;</span>
% SADD users C</pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>B is quite popular, so C will follow him as well.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;User C follows user B&quot;</span>
% SADD users:C:following B
% SADD users:B:followers C</pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>A follows nearly everybody, so let him follow C.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;User A follows user C&quot;</span>
% SADD users:A:following C
% SADD users:C:followers A</pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Now, let&rsquo;s have a look at the relationships we have here.
We can see A is really not being followed by anyone.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Display A&#39;s followers&quot;</span>
% SMEMBERS users:A:followers</pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>B, as said, is quite popular, and is being followed by both A and C.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Display B&#39;s followers&quot;</span>
% SMEMBERS users:B:followers</pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>And C is being followwed by A.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Display C&#39;s followers&quot;</span>
% SMEMBERS users:C:followers</pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>OK, it&rsquo;s time for B to tweet something.</p>

<p>We will store the published time and message body directly in the message
itself. In real world, we would just use JSON.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$(t);Message from B&quot;</span>
+ <span class="s2">&quot;B publishes message &#39;$message&#39;&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>We will see how “query-needs” based schema, often called “denormalization”
 in the RDBMS world really play here. We&rsquo;re optimizing for the maximum <strong>read
performance</strong>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>First, we have to push the message to the global timeline, possibly
displayed on the “twitter” homepage. We will use a Redis <em>list</em>
for storing the tweets.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH global:timeline <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Second, we will push the message to the B&rsquo;s own messages list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH users:B:timeline <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>And, most importantly, third, we have to push the message into
the “inbox” of every user following B, which is A and C in our case.
This will be a bit more tricky.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>First, we have to get a list of all followers of B.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% SMEMBERS users:B:followers | <span class="se">\</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Then, we have to iterate over this list, and push B&rsquo;s message
into the timeline of each user.</p>

<p>We&rsquo;ll cheat here, and JUST USE RUBY, reading the list from standard input.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>ruby -e <span class="s2">&quot;</span>
<span class="s2">  followers = STDIN.read.split(\&quot;\n\&quot;)</span>
<span class="s2">  message   = ENV[&#39;message&#39;]</span>

<span class="s2">  followers.each do |f|</span>
<span class="s2">    system %Q|redis-cli -n #{ENV[&#39;db&#39;]} LPUSH users:#{f}:timeline &#39;#{message}&#39;|</span>
<span class="s2">  end</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Now, let C tweet something, as well.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$(t);Message from C&quot;</span>
+ <span class="s2">&quot;C publishes message &#39;$message&#39;&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>We have to run through the loop once again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>1) push the message to the global timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH global:timeline <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>2) push the message to C&rsquo;s own timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH users:C:timeline <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>3) push the message to C&rsquo;s followers timelines</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% SMEMBERS users:C:followers | <span class="se">\</span>
ruby -e <span class="s2">&quot;</span>
<span class="s2">  followers = STDIN.read.split(\&quot;\n\&quot;)</span>
<span class="s2">  message   = ENV[&#39;message&#39;]</span>

<span class="s2">  followers.each do |f|</span>
<span class="s2">    system %Q|redis-cli -n #{ENV[&#39;db&#39;]} LPUSH users:#{f}:timeline &#39;#{message}&#39;|</span>
<span class="s2">  end</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>And finally, let A tweet something as well. We know the drill, now.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$(t);Message from A&quot;</span>
+ <span class="s2">&quot;A publishes message &#39;$message&#39;&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>We have to push the message to:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>1) the global timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH global:timeline <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>2) A&rsquo;s own timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH users:A:timeline <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>3) all A&rsquo;s followers timeline (empty in this case).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% SMEMBERS users:A:followers | <span class="se">\</span>
ruby -e <span class="s2">&quot;</span>
<span class="s2">  followers = STDIN.read.split(\&quot;\n\&quot;)</span>
<span class="s2">  message   = ENV[&#39;message&#39;]</span>

<span class="s2">  followers.each do |f|</span>
<span class="s2">    system %Q|redis-cli -n #{ENV[&#39;db&#39;]} LPUSH users:#{f}:timeline &#39;#{message}&#39;|</span>
<span class="s2">  end</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Now would be the good time to display some tweets.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p> Let&rsquo;s display A&rsquo;s timeline, trimming it to 10 messages.
We can see it contains two tweets, from C and B, in reversed
order they were published: C&rsquo;s tweet comes first.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;A&#39;s timeline:&quot;</span>
% LRANGE users:A:timeline 0 9</pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>How does B&rsquo;s timeline look like? It contains just his own tweet.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;B&#39;s timeline:&quot;</span>
% LRANGE users:B:timeline 0 9</pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>And C&rsquo;s timeline? It contains his own tweet, first, and an earlier
tweet from B, second.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;C&#39;s timeline:&quot;</span>
% LRANGE users:C:timeline 0 9</pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>We can just as easily display the global timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Global timeline:&quot;</span>
% LRANGE global:timeline 0 9</pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>Of course, we are esentially duplicating the same message in all the user
timeline. This way, we would eat out RAM very quickly. How much memory
does our “twitter” use now?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Memory usage:&quot;</span>
% info | <span class="se">\g</span>rep <span class="s2">&quot;used_memory_human&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>We can de-duplicate the messages by storing them by ID, and storing
only those IDs in user timelines, instead of full messages.
Let&rsquo;s have a shot at that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>OK, let&rsquo;s clear everything first.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% FLUSHDB</pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>Now, let&rsquo;s again add some users.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Adding users A, B and C&quot;</span>
% SADD users A B C</pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>Let&rsquo;s add the relationships:</p>

<ul>
<li>A follows B and C</li>
<li>C follows B</li>
<li>B does not follow anybody</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;User A follows user B and C&quot;</span>
% SADD users:A:following B C
% SADD users:B:followers A
% SADD users:C:followers A
+ <span class="s2">&quot;User C follows user B&quot;</span>
% SADD users:C:following B
% SADD users:B:followers C</pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>Let B tweet something.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$(t);Message from B&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>We will store every tweet in under a separate key, with unique ID.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>Let&rsquo;s get a unique, “auto-incrementing” ID, saving it in a <code>$id</code> variable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;$( % INCR tweets:next_id | tr -d &quot;</span> <span class="s2">&quot; )&quot;</span>
+ <span class="s2">&quot;B publishes message &#39;$message&#39; with ID &#39;$id&#39;&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>Let&rsquo;s store the message content under a key.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% SET tweets:<span class="nv">$id</span> <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>Can we get it back? We can.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% GET tweets:1</pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>Now, we have to push the ID to all the timelines, as in the previous implementation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-50'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-50">&#182;</a>
        </div>
        <p>The global timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH global:timeline <span class="nv">$id</span></pre></div>
      </td>
    </tr>
    <tr id='section-51'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-51">&#182;</a>
        </div>
        <p>B&rsquo;s own timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH users:B:timeline <span class="nv">$id</span></pre></div>
      </td>
    </tr>
    <tr id='section-52'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-52">&#182;</a>
        </div>
        <p>all B&rsquo;s followers timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% SMEMBERS users:B:followers | <span class="se">\</span>
ruby -e <span class="s2">&quot;</span>
<span class="s2">  followers = STDIN.read.split(\&quot;\n\&quot;)</span>
<span class="s2">  id        = ENV[&#39;id&#39;]</span>

<span class="s2">  followers.each do |f|</span>
<span class="s2">    system %Q|redis-cli -n #{ENV[&#39;db&#39;]} LPUSH users:#{f}:timeline &#39;#{id}&#39;|</span>
<span class="s2">  end</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-53'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-53">&#182;</a>
        </div>
        <p>We should now have the tweet ID stored in relevant timelines.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-54'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-54">&#182;</a>
        </div>
        <p>Let&rsquo;s have a look on the global one:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Global timeline (IDs):&quot;</span>
% LRANGE global:timeline 0 -1</pre></div>
      </td>
    </tr>
    <tr id='section-55'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-55">&#182;</a>
        </div>
        <p>We get back only the IDs. When we want to retrieve the messages itself, we have
to fetch them from the relevant keys. It&rsquo;s kinda tricky with the command
line client, but doable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Global timeline (messages):&quot;</span>
% LRANGE global:timeline 0 -1 | <span class="se">\</span>
xargs <span class="nb">echo</span> | <span class="se">\</span></pre></div>
      </td>
    </tr>
    <tr id='section-56'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-56">&#182;</a>
        </div>
        <p>We will simply replace every numeric ID with the corresponding key in the form <code>tweets:&lt;ID&gt;</code>&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>sed <span class="s1">&#39;s/\([0-9]\)/tweets:&amp;/g&#39;</span> | <span class="se">\</span></pre></div>
      </td>
    </tr>
    <tr id='section-57'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-57">&#182;</a>
        </div>
        <p>&hellip; and feed it to the <code>redis-cli</code>&rsquo;s <a href="http://redis.io/commands/mget"><code>MGET</code></a> command.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>xargs redis-cli -n <span class="nv">$db</span> MGET</pre></div>
      </td>
    </tr>
    <tr id='section-58'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-58">&#182;</a>
        </div>
        <p>Now, let C tweet something, again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-59'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-59">&#182;</a>
        </div>
        <p>Let&rsquo;s get some ID, again</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;$( % INCR tweets:next_id | tr -d &quot;</span> <span class="s2">&quot; )&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-60'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-60">&#182;</a>
        </div>
        <p>Let&rsquo;s store the message content under a key, again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$(t);Message from C&quot;</span>
+ <span class="s2">&quot;C publishes message &#39;$message&#39; with ID &#39;$id&#39;&quot;</span>
% SET tweets:<span class="nv">$id</span> <span class="s2">&quot;$message&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-61'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-61">&#182;</a>
        </div>
        <p>Now, we have to push the ID to all the timelines, again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-62'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-62">&#182;</a>
        </div>
        <p>The global timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH global:timeline <span class="nv">$id</span></pre></div>
      </td>
    </tr>
    <tr id='section-63'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-63">&#182;</a>
        </div>
        <p>C&rsquo;s own timeline,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% LPUSH users:C:timeline <span class="nv">$id</span></pre></div>
      </td>
    </tr>
    <tr id='section-64'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-64">&#182;</a>
        </div>
        <p>all C&rsquo;s followers timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>% SMEMBERS users:C:followers | <span class="se">\</span>
ruby -e <span class="s2">&quot;</span>
<span class="s2">  followers = STDIN.read.split(\&quot;\n\&quot;)</span>
<span class="s2">  id        = ENV[&#39;id&#39;]</span>

<span class="s2">  followers.each do |f|</span>
<span class="s2">    system %Q|redis-cli -n #{ENV[&#39;db&#39;]} LPUSH users:#{f}:timeline &#39;#{id}&#39;|</span>
<span class="s2">  end</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-65'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-65">&#182;</a>
        </div>
        <p>And finally, let&rsquo;s repeat everything for A as well.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">export </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;$( % INCR tweets:next_id | tr -d &quot;</span> <span class="s2">&quot; )&quot;</span>
<span class="nb">export </span><span class="nv">message</span><span class="o">=</span><span class="s2">&quot;$(t);Message from A&quot;</span>
+ <span class="s2">&quot;A publishes message &#39;$message&#39; with ID &#39;$id&#39;&quot;</span>
% SET tweets:<span class="nv">$id</span> <span class="s2">&quot;$message&quot;</span>

% LPUSH global:timeline <span class="nv">$id</span>

% LPUSH users:A:timeline <span class="nv">$id</span>

% SMEMBERS users:A:followers | <span class="se">\</span>
ruby -e <span class="s2">&quot;</span>
<span class="s2">  followers = STDIN.read.split(\&quot;\n\&quot;)</span>
<span class="s2">  id        = ENV[&#39;id&#39;]</span>

<span class="s2">  followers.each do |f|</span>
<span class="s2">    system %Q|redis-cli -n #{ENV[&#39;db&#39;]} LPUSH users:#{f}:timeline &#39;#{id}&#39;|</span>
<span class="s2">  end</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-66'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-66">&#182;</a>
        </div>
        <p> Now would be the good time to display the timelines, again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-67'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-67">&#182;</a>
        </div>
        <p>Note, that we cannot simply pull messages from the timelines,
since we are storing only IDs. We have to feed the fetched
IDs to <code>MGET</code> again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-68'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-68">&#182;</a>
        </div>
        <p>A&rsquo;s timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;A&#39;s timeline:&quot;</span>
% LRANGE users:A:timeline 0 9 | xargs <span class="nb">echo</span> | <span class="se">\</span>
  sed <span class="s1">&#39;s/\([0-9]\)/tweets:&amp;/g&#39;</span> | <span class="se">\</span>
  xargs redis-cli -n <span class="nv">$db</span> MGET</pre></div>
      </td>
    </tr>
    <tr id='section-69'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-69">&#182;</a>
        </div>
        <p>B&rsquo;s timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;B&#39;s timeline:&quot;</span>
% LRANGE users:B:timeline 0 9 | xargs <span class="nb">echo</span> | <span class="se">\</span>
  sed <span class="s1">&#39;s/\([0-9]\)/tweets:&amp;/g&#39;</span> | <span class="se">\</span>
  xargs redis-cli -n <span class="nv">$db</span> MGET</pre></div>
      </td>
    </tr>
    <tr id='section-70'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-70">&#182;</a>
        </div>
        <p>C&rsquo;s timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;C&#39;s timeline:&quot;</span>
% LRANGE users:C:timeline 0 9 | xargs <span class="nb">echo</span> | <span class="se">\</span>
  sed <span class="s1">&#39;s/\([0-9]\)/tweets:&amp;/g&#39;</span> | <span class="se">\</span>
  xargs redis-cli -n <span class="nv">$db</span> MGET</pre></div>
      </td>
    </tr>
    <tr id='section-71'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-71">&#182;</a>
        </div>
        <p>Global timeline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Global timeline:&quot;</span>
% LRANGE global:timeline 0 9 | xargs <span class="nb">echo</span> | <span class="se">\</span>
  sed <span class="s1">&#39;s/\([0-9]\)/tweets:&amp;/g&#39;</span> | <span class="se">\</span>
  xargs redis-cli -n <span class="nv">$db</span> MGET</pre></div>
      </td>
    </tr>
    <tr id='section-72'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-72">&#182;</a>
        </div>
        <p>How does our RAM usage look now? You can see it&rsquo;s actually <em>larger</em> then
in the previous case, most probably because we&rsquo;re using a larger pool
of keys now. There&rsquo;s no free lunch in computer science.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>+ <span class="s2">&quot;Memory usage:&quot;</span>
% info | <span class="se">\g</span>rep <span class="s2">&quot;used_memory_human&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-73'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-73">&#182;</a>
        </div>
        <p>You may wonder, now, how we display the count of tweets for specific user,
for instance. Actually, there&rsquo;s no way to do that.</p>

<p>One solution would be to continue with the “query-based” schema, and
just keep track of counts manually, in a counter such as <code>users:A:tweets:count</code>.</p>

<p>Another solution would be to use <a href="http://redis.io/commands#sorted_set"><em>sorted sets</em></a>
for tweets, with one set per user, using timestamp as the score.</p>

<p>But that would shift the perspective to “data-based” schema, and we would have to walk
through all the sets of all the followers when displaying user&rsquo;s timeline, using
<a href="http://redis.io/commands/zrevrangebyscore"><code>ZREVRANGEBYSCORE</code></a> to get a limited set of IDs,
and then perform a <a href="http://redis.io/commands/zunionstore"><code>ZUNIONSTORE</code></a>
to store them in an easily accessible set, sorted by timestamp.</p>

<p>And that would certainly be a <em>very</em> expensive set of operations.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
